!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports.SharedMapReduce=r():e.SharedMapReduce=r()}(this,function(){return function(e){function r(t){if(n[t])return n[t].exports;var o=n[t]={exports:{},id:t,loaded:!1};return e[t].call(o.exports,o,o.exports,r),o.loaded=!0,o.exports}var n={};return r.m=e,r.c=n,r.p="",r(0)}([function(e,r,n){e.exports=n(1)},function(e,r){"use strict";function n(e){if(Array.isArray(e)){for(var r=0,n=Array(e.length);r<e.length;r++)n[r]=e[r];return n}return Array.from(e)}function t(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}(),a=navigator.hardwareConcurrency||8,u=function(){function e(r,o){var u=this;t(this,e),this.queue=[],this.counter=1;var i=["var cpus=",a,";var f=",r.toString(),";var onmsg=",o.toString(),";onmessage=function(e){onmsg(e,cpus,f,postMessage);}"],c=void 0,f=void 0;c=window.URL.createObjectURL(new Blob(i,{type:"application/javascript"})),f=window.URL.revokeObjectURL,this.pool=new Array(a);for(var s=function(e){var r=new Worker(c),t=u;r.onmessage=function(){if(1===t.counter){if(t.cb(),t.queue.length>0){var e=t.queue.shift();t.sendall.apply(t,n(e))}}else t.counter--},r.onerror=function(e){t.err(e)},u.pool[e]=r},l=0;a>l;l++)s(l);f(c)}return o(e,[{key:"sendall",value:function(e,r,n,t){this.counter=a,this.cb=n,this.err=t;for(var o=0;o<this.pool.length;o++){var u=this.pool[o];u.postMessage(e.concat(o),r),u.onerror=t}}},{key:"run",value:function(e,r,n,t){1===this.counter?this.sendall(e,r,n,t):this.queue.push([e,r,n,t])}},{key:"free",value:function(){var e=!0,r=!1,n=void 0;try{for(var t,o=this.pool[Symbol.iterator]();!(e=(t=o.next()).done);e=!0){var a=t.value;a.terminate()}}catch(u){r=!0,n=u}finally{try{!e&&o["return"]&&o["return"]()}finally{if(r)throw n}}}}]),e}(),i=function(){function e(r){t(this,e),this.data=r}return o(e,[{key:"map",value:function(e){var r=this;return new Promise(function(n,t){var o=new r.data.constructor(new SharedArrayBuffer(r.data.buffer.byteLength)),a=function(){return n(o)};e.run([r.data,o],[],a,t)})}},{key:"reduce",value:function(e){var r=this;return new Promise(function(n,t){var o=new r.data.constructor(new SharedArrayBuffer(a*r.data.BYTES_PER_ELEMENT)),u=new Int32Array(new SharedArrayBuffer(a<<1)),i=function(){return n(o[0])};e.run([r.data,o,u],[],i,t)})}},{key:"mapreduce",value:function(r,n,t){var o=this;return new Promise(function(t,a){o.map(r).then(function(r){var o=new e(r);o.reduce(n).then(function(e){t(e)})["catch"](function(e){a(e)})})["catch"](function(e){a(e)})})}}],[{key:"mapf",value:function(e){return new u(e,function(e,r,n,t){for(var o=e.data,a=o[2],u=o[0],i=o[1],c=u.length,f=a;c>f;f+=r)i[f]=n(u[f],f,u);t(0)})}},{key:"reducef",value:function(e){return new u(e,function(e,r,n,t){var o=e.data,a=o[3],u=o[0],i=o[1],c=u.length,f=o[2],s=r;i[a]=u[a];for(var l=a+s;c>l;l+=s)i[a]=n(i[a],u[l]);s>>=1;for(var v=0;s>0;v++,s>>=1){a>=s&&(a-=s);var d=(2<<v)-1;if((Atomics.or(f,a,1<<v)&d)!=d)break;i[a]=n(i[a],i[a+s])}t(0)})}}]),e}();r["default"]=i}])});